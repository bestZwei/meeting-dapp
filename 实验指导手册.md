# 会议报名DApp实验详细指导

## 📖 实验概述

本实验将引导您完成一个完整的去中心化会议报名应用(DApp)的开发，包括：
- ✅ Solidity智能合约开发
- ✅ Truffle框架使用
- ✅ 以太坊私有链搭建
- ✅ Web3.js前端集成
- ✅ 完整的测试流程

## 🎯 实验目标

1. **智能合约功能**：会议创建、用户注册、报名、委托报名
2. **区块链技术**：以太坊私有链部署和合约交互
3. **前端开发**：Web3.js实现区块链应用前端
4. **完整流程**：从开发到部署的完整DApp开发流程

## 🛠️ 详细实验步骤

### 步骤1: 环境准备

#### 1.1 安装必要工具

```powershell
# 1. 安装Node.js (建议版本16.x或18.x)
# 访问 https://nodejs.org/ 下载安装

# 2. 验证安装
node --version
npm --version

# 3. 安装Truffle框架
npm install -g truffle

# 4. 验证Truffle安装
truffle version
```

#### 1.2 安装Ganache

**方法1: GUI版本（推荐初学者）**
- 访问：https://trufflesuite.com/ganache/
- 下载并安装Ganache GUI版本

**方法2: 命令行版本**
```powershell
npm install -g ganache-cli
```

#### 1.3 安装项目依赖

```powershell
# 在项目根目录执行
npm install
```

### 步骤2: 启动开发环境

#### 2.1 启动Ganache

**使用GUI版本：**
1. 打开Ganache应用
2. 点击 "Quick Start" 快速启动
3. 确认配置：
   - RPC服务器：`http://127.0.0.1:8545`
   - 网络ID：`5777` (默认)
   - 账户数量：10个账户，每个100 ETH

**使用命令行版本：**
```powershell
ganache-cli --host 127.0.0.1 --port 8545 --accounts 10 --defaultBalanceEther 100
```

#### 2.2 验证环境

```powershell
# 编译合约
truffle compile

# 如果编译成功，说明环境配置正确
```

### 步骤3: 智能合约分析

#### 3.1 合约结构分析

您的 `Enrollment.sol` 合约包含以下核心功能：

```solidity
// 主要数据结构
struct Participant {
    string name;                    // 参与者姓名
    bool isRegistered;             // 注册状态
    uint[] enrolledConferences;    // 已报名会议列表
}

struct Conference {
    string name;                   // 会议名称
    uint maxParticipants;          // 最大参与人数
    uint currentParticipants;      // 当前参与人数
    bool isFull;                   // 是否满员
    address[] participants;        // 参与者地址列表
    mapping(address => bool) isEnrolled; // 报名状态映射
}
```

#### 3.2 关键函数说明

| 函数名 | 功能 | 权限 |
|--------|------|------|
| `signUp(string _name)` | 用户注册 | 所有用户 |
| `newConference(string _name, uint _max)` | 创建会议 | 仅管理员 |
| `enroll(uint _conferenceId)` | 自己报名 | 已注册用户 |
| `delegate(address _trustee)` | 设置委托 | 已注册用户 |
| `enrollFor(address _participant, uint _confId)` | 代理报名 | 受托方 |
| `queryConfList()` | 查询可报名会议 | 所有人 |
| `queryMyConf()` | 查询我的会议 | 已注册用户 |

### 步骤4: 合约测试

#### 4.1 运行单元测试

```powershell
# 运行所有测试
truffle test

# 运行特定测试文件
truffle test test/TestEnrollment.js
```

#### 4.2 测试用例分析

测试覆盖以下场景：
- ✅ 合约初始化
- ✅ 用户注册（正常、重复、空名称）
- ✅ 会议创建（管理员权限、参数验证）
- ✅ 报名功能（正常报名、权限检查、满员处理）
- ✅ 委托报名（设置委托、代理报名、权限验证）
- ✅ 查询功能（会议列表、个人会议）
- ✅ 事件触发（各种操作的事件）

#### 4.3 测试结果解读

成功的测试输出应该类似：
```
Contract: Enrollment
  合约初始化
    ✓ 应该正确设置管理员
    ✓ 应该初始化空的会议列表
  参与者注册功能
    ✓ 应该允许用户注册
    ✓ 不应该允许重复注册
    ✓ 不应该允许空姓名注册
  会议管理功能
    ✓ 管理员应该能够创建会议
    ✓ 非管理员不应该能够创建会议
  ...

  18 passing (XXXms)
```

### 步骤5: 合约部署

#### 5.1 部署到私有链

```powershell
# 部署合约
truffle migrate --reset

# 成功输出示例：
# > Deploying 'Enrollment'
# > transaction hash: 0x...
# > contract address: 0x...
# > gas used: XXX
```

#### 5.2 验证部署

```powershell
# 进入Truffle控制台
truffle console

# 在控制台中验证
> let instance = await Enrollment.deployed()
> let admin = await instance.administrator()
> console.log("管理员地址:", admin)
> let count = await instance.getConferenceCount()
> console.log("会议数量:", count.toString())
```

#### 5.3 运行交互演示

```powershell
# 运行合约交互脚本
truffle exec scripts/interact.js

# 这将演示完整的合约功能流程
```

### 步骤6: 前端集成

#### 6.1 配置合约地址

1. 从部署输出中复制合约地址
2. 在 `src/app.js` 文件中找到这一行：
```javascript
const contractAddress = ""; // 请在部署合约后填入实际地址
```
3. 将合约地址填入：
```javascript
const contractAddress = "0x你的合约地址";
```

#### 6.2 启动前端服务器

```powershell
# 进入src目录
cd src

# 启动简单HTTP服务器
# 方法1: 使用Python (如果已安装)
python -m http.server 8080

# 方法2: 使用Node.js http-server
npm install -g http-server
http-server -p 8080

# 方法3: 使用VS Code Live Server插件
```

#### 6.3 安装MetaMask

1. 在浏览器中安装MetaMask插件
2. 创建或导入钱包
3. 添加本地网络：
   - 网络名称：`本地测试网`
   - RPC URL：`http://127.0.0.1:8545`
   - 链ID：`1337` 或 `5777`
   - 货币符号：`ETH`

#### 6.4 导入测试账户

1. 从Ganache中复制账户私钥
2. 在MetaMask中导入账户：
   - 点击账户图标 → 导入账户
   - 粘贴私钥
   - 确认导入

### 步骤7: 功能测试

#### 7.1 前端功能测试流程

1. **连接钱包**
   - 打开 `http://localhost:8080`
   - 点击"连接MetaMask"
   - 在MetaMask中确认连接

2. **用户注册**
   - 输入姓名
   - 点击"注册"
   - 在MetaMask中确认交易

3. **创建会议**（使用管理员账户）
   - 输入会议信息
   - 点击"创建会议"
   - 确认交易

4. **报名测试**
   - 刷新会议列表
   - 点击"立即报名"
   - 确认交易

5. **委托功能测试**
   - 设置委托地址
   - 切换到受托方账户
   - 进行代理报名

#### 7.2 常见问题排查

**问题1: MetaMask连接失败**
```
解决方案：
1. 确认Ganache正在运行
2. 检查网络配置是否正确
3. 尝试重置MetaMask账户
```

**问题2: 交易失败**
```
解决方案：
1. 检查账户余额是否足够
2. 确认合约地址是否正确
3. 查看浏览器控制台错误信息
```

**问题3: 合约调用失败**
```
解决方案：
1. 确认用户已注册
2. 检查函数调用权限
3. 验证参数是否正确
```

### 步骤8: 高级功能（选做）

#### 8.1 添加ETH抵押机制

```solidity
// 在合约中添加抵押功能
mapping(address => uint) public deposits;

function enrollWithDeposit(uint _conferenceId) public payable {
    require(msg.value >= 0.01 ether, "Minimum deposit required");
    deposits[msg.sender] += msg.value;
    _enrollInternal(msg.sender, _conferenceId);
}

function withdrawDeposit() public {
    uint amount = deposits[msg.sender];
    require(amount > 0, "No deposit to withdraw");
    deposits[msg.sender] = 0;
    payable(msg.sender).transfer(amount);
}
```

#### 8.2 实现n-m门限委托

```solidity
// 多重签名委托结构
struct MultiSigDelegate {
    address[] trustees;
    uint requiredSignatures;
    mapping(address => bool) signed;
    uint signatureCount;
}

mapping(bytes32 => MultiSigDelegate) public multiSigDelegates;
```

## 🎯 实验评估标准

### 基础功能（70分）
- ✅ 合约编译通过 (10分)
- ✅ 测试用例全部通过 (15分)
- ✅ 成功部署到私有链 (10分)
- ✅ 前端页面正常显示 (10分)
- ✅ 钱包连接成功 (5分)
- ✅ 基本功能测试通过 (20分)

### 高级功能（20分）
- ✅ 委托报名功能 (10分)
- ✅ 事件监听实现 (5分)
- ✅ 错误处理完善 (5分)

### 创新功能（10分）
- ✅ ETH抵押机制 (5分)
- ✅ n-m门限委托 (5分)

## 🔧 故障排除指南

### 编译错误
```
Error: ParserError: Expected identifier but got 'public'
解决方案：检查Solidity版本兼容性，确保pragma版本正确
```

### 部署失败
```
Error: insufficient funds for gas
解决方案：检查账户余额，调整gas价格和限制
```

### 前端连接问题
```
Error: Provider not found
解决方案：确保MetaMask已安装并解锁
```

### 交易失败
```
Error: Transaction has been reverted by the EVM
解决方案：检查合约逻辑，确认交易参数正确
```

## 📚 相关资料

- [Solidity官方文档](https://docs.soliditylang.org/)
- [Truffle框架文档](https://trufflesuite.com/docs/)
- [Web3.js文档](https://web3js.readthedocs.io/)
- [MetaMask使用指南](https://metamask.io/faqs/)

## 🎉 实验总结

完成本实验后，您将：
1. **掌握智能合约开发**：理解Solidity语言和合约设计模式
2. **熟悉开发工具链**：掌握Truffle、Ganache等工具使用
3. **了解DApp架构**：理解去中心化应用的完整技术栈
4. **获得实践经验**：从开发到部署的完整项目经验

这个实验为您进入区块链开发领域打下了坚实的基础！
